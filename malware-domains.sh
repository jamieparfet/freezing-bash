
#!/bin/bash

# This script assumes 4 things:
# 1. The /etc/bind/malware.zones file exists and has an integer on the first line.
# 2. The /etc/bind/blockeddomains.hosts file exists.
# 3. The /root/domain-list file exists.
# 4. curl is installed.

# For every 6 hours: 0 0,6,12,18 * * * /root/malware-domains.sh >/dev/null 2>&1
# One liner to clean: rm /root/domain-list && touch /root/domain-list && echo 1 > /etc/bind/malware.zones

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DATE=$(date "+%Y-%m-%d_%H.%M.%S")
URL="http://mirror1.malwaredomains.com/files/justdomains"
GETSIZE=$(curl -sI "${URL}" | grep Content-Length | sed 's/[^0-9]*//g')
MALDOMAINS="/etc/bind/malware.zones"
ZONEFILE="/etc/bind/blockeddomains.hosts"

read -r FIRSTLINE < "${MALDOMAINS}"
CURRENTSIZE=$(echo "${FIRSTLINE}" | sed 's/[^0-9]*//g')

# If the file lengths do not match
if [ "${CURRENTSIZE}" -ne "${GETSIZE}" ]
then
	# Download the updated list
    mv /root/domain-list /root/old-domain-list
    curl "${URL}" > /root/domain-list

    # Check for differences in the two files
    grep -Fxvf /root/old-domain-list /root/domain-list > /root/differences
    sed -i '/^$/d' /root/differences

    # Append differences to zones file
    while read p; do
      echo "zone \"${p}\" {type master; file \"${ZONEFILE}\";};" >> "${MALDOMAINS}"
    done </root/differences

	# Update first line of zones file with new content length
	sed -i "1s/.*/\/\/$GETSIZE/" "${MALDOMAINS}"

	# Remove old domain list file and differences file
	rm /root/old-domain-list
	rm /root/differences

	service bind9 reload

	# Write date to /tmp dir. Good for debugging
	rm /tmp/cron-updated*
	touch /tmp/cron-updated_"${DATE}".txt
else
	rm /tmp/cron-checked*
	touch /tmp/cron-checked_"${DATE}".txt
fi
