#!/bin/bash

# Cronjob:
# 0 0,6,12,18 * * * /root/download.sh >/dev/null 2>&1

URL="http://mirror1.malwaredomains.com/files/justdomains"
getSize=$(curl -sI "${URL}" | grep Content-Length | sed 's/[^0-9]*//g')
zonesFile="/etc/bind/malware.zones"

echo "${getSize}"

read -r FIRSTLINE < "${zonesFile}"
currentSize=$(echo "${FIRSTLINE}" | sed 's/[^0-9]*//g')
echo "${currentSize}"

# If the file lengths do not match
if [ "${currentSize}" -ne "${getSize}" ]
then
  # Download the updated list
  mv /root/domain-list /root/old-domain-list
  curl "${URL}" > /root/domain-list
  
  # Check for differences in the two files
  grep -Fxvf /root/old-domain-list /root/domain-list > /root/differences
  sed -i '/^$/d' /root/differences

  # Append differences to zones file
  while read p; do
  echo "zone \"${p}\"  {type master; file \"/etc/bind/blockeddomains.hosts\";};" >> "${zonesFile}"
  done </root/differences

  # Update first line of zones file with new content length
  sed -i "1s/.*/\/\/$getSize/" "${zonesFile}"

  # Remove old domain list file and differences file
  rm /root/old-domain-list
  rm /root/differences

  service bind9 reload
  
else
  echo "OK"
fi
